(function(){"use strict";parent.window.__TREEPROMPT__STYLES__="._7xvsjefI{padding:8px 12px;margin:4px 0;background:var(--ls-secondary-background-color, #f9f9f9);border-left:3px solid var(--ls-link-text-color, #4A90E2);border-radius:4px;font-size:13px;line-height:1.5;color:var(--ls-primary-text-color, #333);word-wrap:break-word}._7xvsjefI:hover{background:var(--ls-tertiary-background-color, #f0f0f0)}.-p6wm-u2{padding:20px;text-align:center;color:var(--ls-secondary-text-color, #999);font-style:italic;font-size:13px}.WfqR3zRL{padding:8px 12px;margin:4px 0;background:var(--ls-secondary-background-color, #f9f9f9);border-left:3px solid var(--ls-link-text-color, #4A90E2);border-radius:4px;font-size:13px;line-height:1.5;color:var(--ls-primary-text-color, #333);word-wrap:break-word;cursor:pointer;transition:all .2s}.WfqR3zRL:hover{background:var(--ls-tertiary-background-color, #f0f0f0);border-left-color:var(--ls-link-text-hover-color, #357ABD)}.rKSPsUMG{display:flex;flex-direction:column;gap:8px}.-mIb9pA1{display:flex;gap:4px;padding:4px 8px;background:var(--ls-secondary-background-color, #f5f5f5);border-radius:4px}.jXbO-jtu{flex:1;padding:6px 12px;background:none;border:none;border-bottom:2px solid transparent;border-radius:3px;cursor:pointer;font-size:12px;font-weight:500;color:var(--ls-secondary-text-color, #666);transition:all .2s}.jXbO-jtu:hover{background:var(--ls-tertiary-background-color, #e0e0e0);color:var(--ls-primary-text-color, #333)}.jXbO-jtu.BkhVjgsd{background:var(--ls-primary-background-color, #fff);color:var(--ls-link-text-color, #4A90E2);border-bottom:2px solid var(--ls-link-text-color, #4A90E2)}._86G2YxEn{display:flex;flex-direction:column;gap:0}.JBeKtIPP{padding:1rem;color:var(--ls-secondary-text-color, #999);text-align:center}.m3Ucrj-H{display:flex;align-items:center;gap:6px;padding:4px 8px;font-size:12px;color:var(--ls-secondary-text-color, #666);cursor:pointer}.m3Ucrj-H input{margin:0;cursor:pointer}.quLxPyiy{position:fixed;top:60px;right:20px;width:350px;max-height:600px;background:var(--ls-primary-background-color, #fff);border:1px solid var(--ls-border-color, #ccc);border-radius:8px;box-shadow:0 4px 12px #00000026;z-index:999;display:flex;flex-direction:column;font-family:var(--ls-font-family, sans-serif)}.gCgDXH-h{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--ls-border-color, #e0e0e0);background:var(--ls-secondary-background-color, #f5f5f5);border-radius:8px 8px 0 0}.TxSc0uZg{font-weight:600;font-size:14px;color:var(--ls-primary-text-color, #333);flex:1;text-align:center}.iQA6d99D,.LibF4VnG{background:none;border:none;cursor:pointer;color:var(--ls-primary-text-color, #666);padding:0;width:24px;height:24px;display:flex;align-items:center;justify-content:center;border-radius:4px;flex-shrink:0}.LibF4VnG{font-size:24px;line-height:1}.iQA6d99D:hover,.LibF4VnG:hover{background:var(--ls-tertiary-background-color, #e0e0e0)}.iQA6d99D.KCUQ9FYe{visibility:hidden}.t8uagpFY{display:flex;border-bottom:1px solid var(--ls-border-color, #e0e0e0);background:var(--ls-secondary-background-color, #f5f5f5)}.HQ2ZO8zc{flex:1;padding:10px 12px;background:none;border:none;border-bottom:2px solid transparent;cursor:pointer;font-size:13px;font-weight:500;color:var(--ls-secondary-text-color, #666);transition:all .2s}.HQ2ZO8zc:hover{background:var(--ls-tertiary-background-color, #e8e8e8);color:var(--ls-primary-text-color, #333)}.HQ2ZO8zc.cPqm6Cby{color:var(--ls-link-text-color, #4A90E2);border-bottom-color:var(--ls-link-text-color, #4A90E2);background:var(--ls-primary-background-color, #fff)}.rJD2f9Xa{overflow-y:auto;max-height:552px;padding:8px}"})();
import{g as ue}from"./logseq-xhvj8DO4.js";import{c as R,a as de,o as G,b as we,t as _,i as L,d as O,e as E,f as v,M as D,F as re,S as oe,g as J,s as ge,h as V,j,k as Y,l as ke,m as ie,r as Te}from"./vendor-k_q9bAfL.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const s of a.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&o(s)}).observe(document,{childList:!0,subtree:!0});function e(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(i){if(i.ep)return;i.ep=!0;const a=e(i);fetch(i.href,a)}})();const w={USER:"USER",ASSISTANT:"ASSISTANT",NOTE:"NOTE",OPTION:"OPTION",THREAD:"THREAD",PREPEND:"PREPEND",QUESTION:"QUESTION",TODO:"TODO",DOING:"DOING",BLOCKER:"BLOCKER"};function U(n){if(!n)return{types:[],content:""};const t=n.trim(),e=Object.values(w),o=t.split(/\s+/),i=[];for(const s of o)if(e.includes(s))i.push(s);else break;const a=o.slice(i.length).join(" ");return{types:i,content:a}}function fe(n,t=0){const e=[];for(const o of n)e.push({uuid:o.uuid,content:o.content??"",level:t}),o.children&&e.push(...fe(o.children,t+1));return e}function Pe(n,t){const e=[];for(const o of n){const i=U(o.content);t(i.types)&&e.push({uuid:o.uuid,content:o.content,level:o.level})}return e}function pe(n,t){let e=0;if(!n.children)return e;for(const o of n.children){const i=U(o.content);t(i.types)&&e++,e+=pe(o,t)}return e}function Ee(n){const t=new Map;function e(o){for(const i of o)t.set(i.uuid,i),i.children&&e(i.children)}return e(n),t}function Z(n,t){const e=fe(n),o=Pe(e,t),i=Ee(n),a=o.map(s=>{const h=i.get(s.uuid),C=h?pe(h,t):0;return{uuid:s.uuid,content:s.content,nestedCount:C,level:s.level}});return a.sort((s,h)=>s.nestedCount!==h.nestedCount?s.nestedCount-h.nestedCount:h.level-s.level),a.map(({uuid:s,content:h})=>({uuid:s,content:h}))}async function Ce(n,t){let e=await t(n);for(;e;){if(U(e.content).types.includes(w.THREAD))return e.uuid;if(e.parent?.id)e=await t(e.parent.id);else break}return null}function ee(n,t){return t?n:n.filter(e=>!e.isBlocked)}const Be=[w.QUESTION,w.TODO,w.DOING];function Se(n){return Be.some(t=>n.includes(t))}function Ie(n){const t=[];function e(o,i,a){for(const s of o){const h=U(s.content),C=h.types.includes(w.BLOCKER),k=Se(h.types),r=h.types.includes(w.OPTION);C&&t.push({uuid:s.uuid,parentUuid:i,parentIsTask:a,isOption:r}),s.children&&e(s.children,s.uuid,k)}}return e(n,null,!1),t}function Le(n){const t=new Map;function e(o,i){for(const a of o)t.set(a.uuid,i),a.children&&e(a.children,a.uuid)}return e(n,null),t}function le(n,t,e){let o=e.get(t);for(;o!=null;){if(o===n)return!0;o=e.get(o)}return!1}function Oe(n,t,e){for(const o of t)if(le(o.uuid,n,e)||o.parentIsTask&&!o.isOption&&o.parentUuid&&le(o.parentUuid,n,e))return!0;return!1}function he(n){const t=Ie(n),e=Le(n);function o(i){return i.map(a=>({...a,isBlocked:Oe(a.uuid,t,e)}))}return{questions:o(Z(n,i=>i.includes(w.QUESTION))),doing:o(Z(n,i=>i.includes(w.DOING))),todos:o(Z(n,i=>i.includes(w.TODO)))}}function ve(n){return he(n)}async function xe(n,t,e){const o=await Ce(n,e);if(!o)return ve(t);const i=await e(o);return i?he([i]):{questions:[],doing:[],todos:[]}}async function ye(n,t){const e=[];let o=await t(n);if(!o)return e;const i=[],a=new Set;let s=n;for(;o&&(i.unshift({block:o,id:s}),a.add(s),!U(o.content).types.includes(w.THREAD));)if(o.parent?.id){if(s=o.parent.id,a.has(s))break;o=await t(s)}else break;for(const{block:h,id:C}of i){const k=U(h.content),r=k.types.includes(w.THREAD),u=[];if(!r){let p=h,b=C;const d=h.parent?.id||null;for(;p.left?.id;){const c=p.left.id,f=await t(c);if(!f||(p=f,b=c,(p.parent?.id||null)!==d))break;const y=U(p.content);y.types.includes(w.OPTION)&&!a.has(b)||y.types.includes(w.NOTE)||(y.types.includes(w.PREPEND)?e.unshift(y.content):u.unshift(y.content))}}if(e.push(...u),k.types.includes(w.NOTE))return e;k.types.includes(w.PREPEND)?e.unshift(k.content):e.push(k.content)}return e}var Q={exports:{}},Ae=Q.exports,se;function Ne(){return se||(se=1,(function(n){(function(t,e){n.exports?n.exports=e():t.log=e()})(Ae,function(){var t=function(){},e="undefined",o=typeof window!==e&&typeof window.navigator!==e&&/Trident\/|MSIE /.test(window.navigator.userAgent),i=["trace","debug","info","warn","error"],a={},s=null;function h(c,f){var l=c[f];if(typeof l.bind=="function")return l.bind(c);try{return Function.prototype.bind.call(l,c)}catch{return function(){return Function.prototype.apply.apply(l,[c,arguments])}}}function C(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function k(c){return c==="debug"&&(c="log"),typeof console===e?!1:c==="trace"&&o?C:console[c]!==void 0?h(console,c):console.log!==void 0?h(console,"log"):t}function r(){for(var c=this.getLevel(),f=0;f<i.length;f++){var l=i[f];this[l]=f<c?t:this.methodFactory(l,c,this.name)}if(this.log=this.debug,typeof console===e&&c<this.levels.SILENT)return"No console available for logging"}function u(c){return function(){typeof console!==e&&(r.call(this),this[c].apply(this,arguments))}}function p(c,f,l){return k(c)||u.apply(this,arguments)}function b(c,f){var l=this,y,T,g,P="loglevel";typeof c=="string"?P+=":"+c:typeof c=="symbol"&&(P=void 0);function x(m){var B=(i[m]||"silent").toUpperCase();if(!(typeof window===e||!P)){try{window.localStorage[P]=B;return}catch{}try{window.document.cookie=encodeURIComponent(P)+"="+B+";"}catch{}}}function q(){var m;if(!(typeof window===e||!P)){try{m=window.localStorage[P]}catch{}if(typeof m===e)try{var B=window.document.cookie,F=encodeURIComponent(P),H=B.indexOf(F+"=");H!==-1&&(m=/^([^;]+)/.exec(B.slice(H+F.length+1))[1])}catch{}return l.levels[m]===void 0&&(m=void 0),m}}function S(){if(!(typeof window===e||!P)){try{window.localStorage.removeItem(P)}catch{}try{window.document.cookie=encodeURIComponent(P)+"=; expires=Thu, 01 Jan 1970 00:00:00 UTC"}catch{}}}function N(m){var B=m;if(typeof B=="string"&&l.levels[B.toUpperCase()]!==void 0&&(B=l.levels[B.toUpperCase()]),typeof B=="number"&&B>=0&&B<=l.levels.SILENT)return B;throw new TypeError("log.setLevel() called with invalid level: "+m)}l.name=c,l.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},l.methodFactory=f||p,l.getLevel=function(){return g??T??y},l.setLevel=function(m,B){return g=N(m),B!==!1&&x(g),r.call(l)},l.setDefaultLevel=function(m){T=N(m),q()||l.setLevel(m,!1)},l.resetLevel=function(){g=null,S(),r.call(l)},l.enableAll=function(m){l.setLevel(l.levels.TRACE,m)},l.disableAll=function(m){l.setLevel(l.levels.SILENT,m)},l.rebuild=function(){if(s!==l&&(y=N(s.getLevel())),r.call(l),s===l)for(var m in a)a[m].rebuild()},y=N(s?s.getLevel():"WARN");var $=q();$!=null&&(g=N($)),r.call(l)}s=new b,s.getLogger=function(f){if(typeof f!="symbol"&&typeof f!="string"||f==="")throw new TypeError("You must supply a name when creating a logger.");var l=a[f];return l||(l=a[f]=new b(f,s.methodFactory)),l};var d=typeof window!==e?window.log:void 0;return s.noConflict=function(){return typeof window!==e&&window.log===s&&(window.log=d),s},s.getLoggers=function(){return a},s.default=s,s})})(Q)),Q.exports}var qe=Ne();const X=ue(qe);var W={exports:{}},$e=W.exports,ae;function Me(){return ae||(ae=1,(function(n){(function(t,e){n.exports?n.exports=e():t.prefix=e(t)})($e,function(t){var e=function(r){for(var u=1,p=arguments.length,b;u<p;u++)for(b in arguments[u])Object.prototype.hasOwnProperty.call(arguments[u],b)&&(r[b]=arguments[u][b]);return r},o={template:"[%t] %l:",levelFormatter:function(r){return r.toUpperCase()},nameFormatter:function(r){return r||"root"},timestampFormatter:function(r){return r.toTimeString().replace(/.*(\d{2}:\d{2}:\d{2}).*/,"$1")},format:void 0},i,a={},s=function(r){if(!r||!r.getLogger)throw new TypeError("Argument is not a root logger");i=r},h=function(r,u){if(!r||!r.setLevel)throw new TypeError("Argument is not a logger");var p=r.methodFactory,b=r.name||"",d=a[b]||a[""]||o;function c(f,l,y){var T=p(f,l,y),g=a[y]||a[""],P=g.template.indexOf("%t")!==-1,x=g.template.indexOf("%l")!==-1,q=g.template.indexOf("%n")!==-1;return function(){for(var S="",N=arguments.length,$=Array(N),m=0;m<N;m++)$[m]=arguments[m];if(b||!a[y]){var B=g.timestampFormatter(new Date),F=g.levelFormatter(f),H=g.nameFormatter(y);g.format?S+=g.format(F,H,B):(S+=g.template,P&&(S=S.replace(/%t/,B)),x&&(S=S.replace(/%l/,F)),q&&(S=S.replace(/%n/,H))),$.length&&typeof $[0]=="string"?$[0]=S+" "+$[0]:$.unshift(S)}T.apply(void 0,$)}}return a[b]||(r.methodFactory=c),u=u||{},u.template&&(u.format=void 0),a[b]=e({},d,u),r.setLevel(r.getLevel()),i||r.warn("It is necessary to call the function reg() of loglevel-plugin-prefix before calling apply. From the next release, it will throw an error. See more: https://github.com/kutuluk/loglevel-plugin-prefix/blob/master/README.md"),r},C={reg:s,apply:h},k;return t&&(k=t.prefix,C.noConflict=function(){return t.prefix===C&&(t.prefix=k),C}),C})})(W)),W.exports}var Re=Me();const me=ue(Re),De="warn";X.setLevel(De);me.reg(X);me.apply(X,{format(n,t,e){return`[treecraft] ${n}:`}});const I=X;function _e(n={}){const{enablePolling:t=!0,pollingInterval:e=300,debounceDelay:o=150,enableDbListener:i=!0}=n,[a,s]=R(null),[h,C]=R(null),[k,r]=R(!0);let u=null,p=null,b=null,d=null,c=null;const f=async()=>{try{const g=await logseq.Editor.getCurrentBlock(),P=await logseq.Editor.getCurrentPage(),x=P?.name||P?.originalName||null;if(x!==c&&(c=x,C(P||null)),g){const q=g.uuid,S=g.content;(q!==b||S!==d)&&(b=q,d=S,s(g))}else b!==null&&(b=null,d=null,s(null));r(!1)}catch(g){I.error("Error fetching current block:",g),r(!1)}},l=()=>{p&&clearTimeout(p),p=setTimeout(()=>{f()},o)},y=()=>{!t||u||(u=setInterval(()=>{f()},e))},T=()=>{u&&(clearInterval(u),u=null)};return de(()=>{if(f(),i&&logseq.DB&&logseq.DB.onChanged)try{const g=logseq.DB.onChanged(()=>{l()});G(()=>{typeof g=="function"&&g()})}catch(g){I.error("Failed to register DB.onChanged listener:",g)}else I.warn("logseq.DB.onChanged not available, using polling only");t&&(y(),G(T)),G(()=>{p&&clearTimeout(p)})}),{currentBlock:a,currentPage:h,isLoading:k,refresh:f}}function te(n,t,e={}){const{suspenseDelay:o=500}=e,[i,{refetch:a}]=we(n,t),[s,h]=R(void 0),[C,k]=R(!1);let r=null;return de(()=>{if(i.loading)r&&clearTimeout(r),r=setTimeout(()=>{k(!0)},o);else{r&&(clearTimeout(r),r=null),k(!1);const p=i();p!==void 0&&h(p)}}),G(()=>{r&&clearTimeout(r)}),Object.assign(()=>i.loading?C()?i():s():i(),{get loading(){return i.loading},get error(){return i.error},get latest(){return i.latest},refetch:a})}const Fe="_7xvsjefI",Ue={ancestorItem:Fe},He="-p6wm-u2",Ve={emptyState:He};var je=_("<div>");function z(n){return(()=>{var t=je();return L(t,()=>n.children),O(()=>E(t,Ve.emptyState)),t})()}var Ke=_("<div>");function ze(n){return v(oe,{get children(){return[v(D,{get when(){return!n.currentBlock},get children(){return v(z,{children:"No block selected"})}}),v(D,{get when(){return!n.ancestors()||n.ancestors().length===0},get children(){return v(z,{children:"No ancestors found"})}}),v(D,{when:!0,get children(){return v(re,{get each(){return n.ancestors()},children:t=>(()=>{var e=Ke();return L(e,t),O(()=>E(e,Ue.ancestorItem)),e})()})}})]}})}const Ge="WfqR3zRL",Qe={blockItem:Ge};var We=_("<div>");function ne(n){const t=async(e,o)=>{o.shiftKey?await logseq.Editor.openInRightSidebar(e):await logseq.Editor.scrollToBlockInPage(e)};return v(oe,{get children(){return[v(D,{get when(){return n.showNoBlockState},get children(){return v(z,{get children(){return n.noBlockMessage}})}}),v(D,{get when(){return!n.blocks()||n.blocks().length===0},get children(){return v(z,{get children(){return n.emptyMessage}})}}),v(D,{when:!0,get children(){return v(re,{get each(){return n.blocks()},children:e=>(()=>{var o=We();return o.$$click=i=>t(e.uuid,i),L(o,()=>e.content),O(i=>{var a=Qe.blockItem,s=e.uuid;return a!==i.e&&E(o,i.e=a),s!==i.t&&ge(o,"data-block-uuid",i.t=s),i},{e:void 0,t:void 0}),o})()})}})]}})}J(["click"]);const Ye="rKSPsUMG",Je="-mIb9pA1",Xe="jXbO-jtu",Ze="BkhVjgsd",et="_86G2YxEn",tt="MQWfjqxy",nt="JBeKtIPP",rt="m3Ucrj-H",A={taskContainer:Ye,scopeToggle:Je,toggleButton:Xe,active:Ze,taskSections:et,taskSection:tt,emptyState:nt,blockedToggle:rt};var ot=_("<label><input type=checkbox><span>Show blocked"),K=_("<div>"),it=_("<div><div><button>Page</button><button>Thread");function lt(n){const[t,e]=R("page"),[o,i]=R(!1),a=V(()=>t()==="page"?n.pageTasks():n.threadTasks()),s=V(()=>{const r=a();if(r)return{questions:ee(r.questions,o()),doing:ee(r.doing,o()),todos:ee(r.todos,o())}}),h=V(()=>{const r=s();return r&&(r.questions.length>0||r.doing.length>0||r.todos.length>0)}),C=V(()=>{const r=a();return r?r.questions.some(u=>u.isBlocked)||r.doing.some(u=>u.isBlocked)||r.todos.some(u=>u.isBlocked):!1}),k=V(()=>t()==="thread"?n.currentBlock?"No tasks found in thread scope":"No block selected":"No tasks found on this page");return(()=>{var r=it(),u=r.firstChild,p=u.firstChild,b=p.nextSibling;return p.$$click=()=>e("page"),b.$$click=()=>e("thread"),L(r,v(j,{get when(){return C()},get children(){var d=ot(),c=d.firstChild;return c.addEventListener("change",f=>i(f.currentTarget.checked)),O(()=>E(d,A.blockedToggle)),O(()=>c.checked=o()),d}}),null),L(r,v(j,{get when(){return h()},get fallback(){return(()=>{var d=K();return L(d,k),O(()=>E(d,A.emptyState)),d})()},get children(){var d=K();return L(d,v(j,{get when(){return(s()?.questions.length??0)>0},get children(){var c=K();return L(c,v(ne,{blocks:()=>s()?.questions,emptyMessage:""})),O(()=>E(c,A.taskSection)),c}}),null),L(d,v(j,{get when(){return(s()?.doing.length??0)>0},get children(){var c=K();return L(c,v(ne,{blocks:()=>s()?.doing,emptyMessage:""})),O(()=>E(c,A.taskSection)),c}}),null),L(d,v(j,{get when(){return(s()?.todos.length??0)>0},get children(){var c=K();return L(c,v(ne,{blocks:()=>s()?.todos,emptyMessage:""})),O(()=>E(c,A.taskSection)),c}}),null),O(()=>E(d,A.taskSections)),d}}),null),O(d=>{var c=A.taskContainer,f=A.scopeToggle,l=A.toggleButton,y={[A.active]:t()==="page"},T=A.toggleButton,g={[A.active]:t()==="thread"};return c!==d.e&&E(r,d.e=c),f!==d.t&&E(u,d.t=f),l!==d.a&&E(p,d.a=l),d.o=Y(p,y,d.o),T!==d.i&&E(b,d.i=T),d.n=Y(b,g,d.n),d},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0}),r})()}J(["click"]);const st="quLxPyiy",at="gCgDXH-h",ct="TxSc0uZg",ut="iQA6d99D",dt="LibF4VnG",gt="KCUQ9FYe",ft="t8uagpFY",pt="HQ2ZO8zc",ht="cPqm6Cby",vt="rJD2f9Xa",M={panel:st,header:at,title:ct,copyButton:ut,closeButton:dt,hidden:gt,tabs:ft,tabButton:pt,active:ht,content:vt};var yt=_('<div id=ancestor-panel><div><button id=copy-ancestor-panel title="Copy to clipboard"><svg width=16 height=16 viewBox="0 0 16 16"fill=currentColor><path d="M4 2h8a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2zm0 1a1 1 0 0 0-1 1v8a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1H4z"></path><path d="M6 0h6a2 2 0 0 1 2 2v6h-1V2a1 1 0 0 0-1-1H6V0z"></path></svg></button><span>Treecraft</span><button id=close-ancestor-panel>Ã—</button></div><div></div><div id=ancestor-panel-content>'),mt=_("<button>");async function ce(n,t){const e=await logseq.Editor.getCurrentPageBlocksTree();if(e&&e.length>1)return e;if(n){const o=n.name||n.uuid,i=await logseq.Editor.getPageBlocksTree(o);if(i&&i.length>0)return i}if(t?.page?.id){const o=await logseq.Editor.getPage(t.page.id);if(o){const i=o.name||o.originalName||o.uuid,a=await logseq.Editor.getPageBlocksTree(i);if(a&&a.length>0)return a}}return e||[]}const bt=[{id:"prompt",label:"Prompt"},{id:"tasks",label:"Tasks"}];function wt(n){const[t,e]=R("prompt"),{currentBlock:o,currentPage:i}=_e({enablePolling:!0,enableDbListener:!0,pollingInterval:300,debounceDelay:150}),a=te(()=>o()?{uuid:o().uuid,content:o().content}:null,async r=>r?.uuid?await ye(r.uuid,logseq.Editor.getBlock):[]),s=te(()=>{const r=o(),u=i();return r?{type:"block",uuid:r.uuid,page:u,block:r}:u?{type:"page",name:u.name,page:u,block:null}:null},async r=>{const u=await ce(r?.page??null,r?.block??null);return ve(u)}),h=te(()=>{const r=o(),u=i();return r?{uuid:r.uuid,content:r.content,page:u,block:r}:null},async r=>{if(!r?.uuid)return{questions:[],doing:[],todos:[]};const u=await ce(r.page??null,r.block??null);return await xe(r.uuid,u,p=>logseq.Editor.getBlock(p,{includeChildren:!0}))}),C=()=>{I.debug("Close clicked"),n.onClose()},k=async()=>{I.debug("Copy clicked");try{const r=a();if(!r||r.length===0){await logseq.App.showMsg("No content to copy","warning");return}const u=r.join(`
`);await parent.navigator.clipboard.writeText(u),await logseq.App.showMsg("Copied to clipboard","success")}catch(r){I.error("Error copying to clipboard:",r),await logseq.App.showMsg("Failed to copy to clipboard","error")}};return(()=>{var r=yt(),u=r.firstChild,p=u.firstChild,b=p.nextSibling,d=b.nextSibling,c=u.nextSibling,f=c.nextSibling;return p.$$click=k,d.$$click=C,L(c,v(re,{each:bt,children:l=>(()=>{var y=mt();return y.$$click=()=>e(l.id),L(y,()=>l.label),O(T=>{var g=M.tabButton,P={[M.active]:t()===l.id},x=l.id;return g!==T.e&&E(y,T.e=g),T.t=Y(y,P,T.t),x!==T.a&&ge(y,"data-tab",T.a=x),T},{e:void 0,t:void 0,a:void 0}),y})()})),L(f,v(ke,{get fallback(){return v(z,{children:"Loading..."})},get children(){return v(oe,{get children(){return[v(D,{get when(){return t()==="prompt"},get children(){return v(ze,{get currentBlock(){return o()},ancestors:a})}}),v(D,{get when(){return t()==="tasks"},get children(){return v(lt,{get currentBlock(){return o()},pageTasks:s,threadTasks:h})}})]}})}})),O(l=>{var y=M.panel,T=M.header,g=M.copyButton,P={[M.hidden]:t()!=="prompt"},x=M.title,q=M.closeButton,S=M.tabs,N=M.content;return y!==l.e&&E(r,l.e=y),T!==l.t&&E(u,l.t=T),g!==l.a&&E(p,l.a=g),l.o=Y(p,P,l.o),x!==l.i&&E(b,l.i=x),q!==l.n&&E(d,l.n=q),S!==l.s&&E(c,l.s=S),N!==l.h&&E(f,l.h=N),l},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0}),r})()}J(["click"]);async function kt(){try{const n=await logseq.Editor.getCurrentBlock();if(!n){await logseq.App.showMsg("No block selected","warning");return}const t=await ye(n.uuid,logseq.Editor.getBlock);if(t.length===0){await logseq.App.showMsg("No content to copy","warning");return}const e=t.join(`
`);await parent.navigator.clipboard.writeText(e),await logseq.App.showMsg("Copied to clipboard'","success")}catch(n){I.error("Error copying tree to clipboard:",n),await logseq.App.showMsg("Failed to copy tree to clipboard","error")}}class Tt{document;panelContainer=null;disposePanel=null;instanceId=Math.random().toString(36).substr(2,9);constructor(t){this.document=t,ie(this.document);const e=this.document.getElementById("treecraft-root");e&&(I.warn(`[${this.instanceId}] Found stale panel on init, removing`),e.remove())}createPanel(){I.debug(`[${this.instanceId}] Creating panel at ${new Date().toISOString()}`);const t=this.document.body,e=this.document.getElementById("treecraft-root");e&&(I.warn(`[${this.instanceId}] Found existing panel during create, removing`),e.remove()),this.panelContainer=this.document.createElement("div"),this.panelContainer.id="treecraft-root",t.appendChild(this.panelContainer),J(["click"],this.document),this.disposePanel=Te(()=>wt({onClose:()=>this.destroyPanel()}),this.panelContainer)}destroyPanel(){I.debug(`[${this.instanceId}] Destroying panel at ${new Date().toISOString()}`),this.disposePanel&&(this.disposePanel(),this.disposePanel=null),ie(this.document),this.panelContainer&&(this.panelContainer.remove(),this.panelContainer=null)}toggle(){I.debug(`[${this.instanceId}] Toggle called, panelContainer exists:`,!!this.panelContainer),this.panelContainer?this.destroyPanel():this.createPanel()}isPanelActive(){return!!this.panelContainer}}async function Pt(n){try{const t=await logseq.Editor.getCurrentBlock();if(!t){await logseq.App.showMsg("No block selected","warning");return}const e=`${n} ${t.content}`;await logseq.Editor.updateBlock(t.uuid,e)}catch(t){I.error(`Error inserting ${n} directive:`,t),await logseq.App.showMsg(`Failed to insert ${n} directive`,"error")}}function Et(){const n=[{type:w.THREAD,label:"Thread"},{type:w.OPTION,label:"Option"},{type:w.NOTE,label:"Note"},{type:w.PREPEND,label:"Prepend"},{type:w.QUESTION,label:"Question"},{type:w.BLOCKER,label:"Blocker"},{type:w.USER,label:"User message"},{type:w.ASSISTANT,label:"Assistant message"}];for(const{type:t,label:e}of n)logseq.Editor.registerSlashCommand(`Treecraft: ${e}`,async()=>await Pt(t))}function Ct(){I.info("Tree to Clipboard plugin loaded"),logseq.provideStyle(parent.window.__TREEPROMPT__STYLES__);const n=parent.window.__TREEPROMPT_PANEL_MANAGER__;n&&(I.debug("Found previous PanelManager instance, cleaning up"),n.destroyPanel());const t=new Tt(parent.document);parent.window.__TREEPROMPT_PANEL_MANAGER__=t,logseq.beforeunload(async()=>{I.debug("Plugin beforeunload - cleaning up"),t.isPanelActive()&&t.destroyPanel()}),logseq.provideModel({treecraftTogglePanel(){I.debug("treecraftTogglePanel model method called"),t.toggle()}}),logseq.App.registerUIItem("toolbar",{key:"treecraft-ancestors",template:`
      <a data-on-click="treecraftTogglePanel"
         class="button"
         title="Toggle Treecraft Panel">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <path d="M2 3h12v2H2V3zm2 4h10v2H4V7zm2 4h8v2H6v-2z"/>
        </svg>
      </a>
    `}),logseq.App.registerCommandPalette({key:"treecraft-copy-prompt-to-clipboard",label:"Treecraft: Copy prompt to clipboard",keybinding:{binding:"mod+alt+c"}},async()=>{await kt()}),logseq.App.registerCommandPalette({key:"treecraft-toggle-panel",label:"Treecraft: Toggle panel",keybinding:{binding:"mod+alt+t"}},async()=>{t.toggle()}),Et()}logseq.ready(Ct).catch(n=>I.error(n));
